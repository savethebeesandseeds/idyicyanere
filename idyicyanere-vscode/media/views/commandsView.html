<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="__CSP__">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --pad: 10px;
      --r: 8px;
      --b: 1px solid var(--vscode-panel-border);
      --muted: var(--vscode-descriptionForeground);
      --bg: var(--vscode-editor-background);
      --bg2: var(--vscode-sideBar-background, var(--vscode-editor-background));
      --fg: var(--vscode-foreground);
      --mono: var(--vscode-editor-font-family);
    }

    body {
      margin: 0;
      padding: var(--pad);
      color: var(--fg);
      font-family: var(--vscode-font-family);
    }

    .topbar{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom: 8px;
    }

    .topbar button{
      padding: 4px 10px;
      border-radius: 6px;
    }

    .search{
      flex: 1;
      min-width: 120px;
      padding: 6px 8px;
      border-radius: 8px;
      border: var(--b);
      background: var(--bg);
      color: var(--fg);
      outline: none;
    }

    .meta{
      display:flex;
      justify-content: space-between;
      gap: 8px;
      margin: 6px 0 10px 0;
      color: var(--muted);
      font-size: 12px;
      user-select: none;
    }

    .table{
      border: var(--b);
      border-radius: var(--r);
      overflow: hidden;
      background: var(--bg);
    }

    .thead, .tr{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap: 8px;
    }

    .thead{
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--bg2);
      border-bottom: var(--b);
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .tbody{
      max-height: calc(100vh - 120px);
      overflow: auto;
    }

    .tr{
      padding: 6px 10px;
      border-bottom: 1px solid color-mix(in srgb, var(--vscode-panel-border) 70%, transparent);
    }
    .tr:last-child{ border-bottom: none; }

    .tr:hover{
      background: color-mix(in srgb, var(--vscode-list-hoverBackground) 60%, transparent);
    }

    .id{
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .actions{
      display:flex;
      gap: 6px;
      align-items:center;
    }

    .iconbtn{
      border: var(--b);
      background: transparent;
      color: var(--fg);
      border-radius: 7px;
      padding: 2px 8px;
      font-size: 12px;
      line-height: 18px;
      cursor: pointer;
      user-select: none;
    }
    .iconbtn:hover{
      background: color-mix(in srgb, var(--vscode-button-background) 20%, transparent);
    }

    .status{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      min-height: 16px;
    }

    .empty{
      padding: 12px 10px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <button id="refresh" class="iconbtn" title="Refresh">↻</button>
    <input id="filter" class="search" type="text" placeholder="Filter idyicyanere.*" spellcheck="false" />
  </div>

  <div class="meta">
    <div><span id="count">0</span> commands</div>
    <div>▶ run · ⧉ copy</div>
  </div>

  <div class="table" role="table" aria-label="Commands">
    <div class="thead" role="row">
      <div role="columnheader">Command</div>
      <div role="columnheader">Actions</div>
    </div>
    <div id="body" class="tbody" role="rowgroup"></div>
  </div>

  <div id="status" class="status"></div>

  <script nonce="__NONCE__">
    const vscode = acquireVsCodeApi();

    const body = document.getElementById('body');
    const filter = document.getElementById('filter');
    const status = document.getElementById('status');
    const count = document.getElementById('count');
    const refreshBtn = document.getElementById('refresh');

    let commands = [];

    // Report webview errors to extension
    window.addEventListener('error', (e) => {
      vscode.postMessage({
        type: 'clientError',
        text: e.message || 'Webview error',
        stack: e.error?.stack
      });
    });
    window.addEventListener('unhandledrejection', (e) => {
      const reason = e.reason?.message ? e.reason.message : String(e.reason);
      vscode.postMessage({
        type: 'clientError',
        text: reason || 'Unhandled rejection',
        stack: e.reason?.stack
      });
    });

    function esc(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function getShown(){
      const q = (filter.value || '').toLowerCase().trim();
      return q ? commands.filter(c => (c.id || '').toLowerCase().includes(q)) : commands;
    }

    function render(){
      const shown = getShown();
      count.textContent = String(shown.length);

      if (!shown.length){
        body.innerHTML = '<div class="empty">No commands match your filter.</div>';
        return;
      }

      body.innerHTML = shown.map(c => {
        const id = c.id || '';
        const safe = esc(id);
        return `
          <div class="tr" role="row" data-id="${safe}">
            <div class="id" role="cell" title="${safe}">${safe}</div>
            <div class="actions" role="cell">
              <button class="iconbtn" data-act="run" title="Run">▶</button>
              <button class="iconbtn" data-act="copy" title="Copy">⧉</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Event delegation: one handler for all rows/buttons
    body.addEventListener('click', async (e) => {
      const btn = e.target?.closest?.('button[data-act]');
      if (!btn) return;

      const row = btn.closest('.tr');
      const id = row?.getAttribute('data-id') || '';
      const act = btn.getAttribute('data-act');

      if (!id) return;

      if (act === 'run'){
        vscode.postMessage({ type: 'run', id });
        status.textContent = 'Running: ' + id;
        return;
      }

      if (act === 'copy'){
        try {
          await navigator.clipboard.writeText(id);
          status.textContent = 'Copied: ' + id;
        } catch {
          vscode.postMessage({ type: 'log', text: 'Copy failed in webview: ' + id });
          status.textContent = 'Copy failed (see logs)';
        }
      }
    });

    refreshBtn.addEventListener('click', () => vscode.postMessage({ type: 'refresh' }));
    filter.addEventListener('input', render);

    window.addEventListener('message', (e) => {
      const msg = e.data;

      if (msg.type === 'commands'){
        commands = msg.commands || [];
        status.textContent = '';
        render();
      } else if (msg.type === 'log'){
        status.textContent = msg.text || '';
      } else if (msg.type === 'error'){
        status.textContent = 'Error: ' + (msg.text || '');
      }
    });

    vscode.postMessage({ type: 'ready' });
  </script>
</body>
</html>